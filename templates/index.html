<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Expense Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-3xl mx-auto">

    <!-- Login Section -->
    <h2 class="text-2xl font-bold mb-2">Login</h2>
    <div class="mb-4">
        <input type="email" id="email" placeholder="Email" class="border p-2 w-full mb-2 rounded">
        <input type="password" id="password" placeholder="Password" class="border p-2 w-full mb-2 rounded">
        <button onclick="login()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Login</button>
        <p id="loginMessage" class="text-red-500 mt-2"></p>
    </div>

    <!-- Add Expense Section -->
    <h2 class="text-2xl font-bold mb-2">Add Expense</h2>
    <div class="mb-4">
        <input type="number" id="amount" placeholder="Amount" class="border p-2 w-full mb-2 rounded">
        <input type="text" id="category" placeholder="Category" class="border p-2 w-full mb-2 rounded">
        <input type="text" id="description" placeholder="Description" class="border p-2 w-full mb-2 rounded">
        <input type="date" id="date" class="border p-2 w-full mb-2 rounded">
        <button onclick="addExpense()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Add Expense</button>
        <p id="expenseMessage" class="text-red-500 mt-2"></p>
    </div>

    <!-- Expenses Table -->
    <h2 class="text-2xl font-bold mb-2">Your Expenses</h2>

    <!-- Sorting & Date Filter -->
    <div class="flex flex-wrap items-center gap-2 mb-2">
        <label>Sort by:</label>
        <select id="sort" onchange="fetchExpenses()" class="border p-2 rounded">
            <option value="date">Date</option>
            <option value="amount">Amount</option>
        </select>

        <label>Start Date:</label>
        <input type="date" id="startDate" class="border p-2 rounded">

        <label>End Date:</label>
        <input type="date" id="endDate" class="border p-2 rounded">

        <button onclick="fetchExpenses()" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Apply</button>
    </div>

    <table class="w-full border-collapse border border-gray-400">
        <thead class="bg-gray-200">
            <tr>
                <th class="border border-gray-400 p-2">Date</th>
                <th class="border border-gray-400 p-2">Category</th>
                <th class="border border-gray-400 p-2">Description</th>
                <th class="border border-gray-400 p-2">Amount</th>
            </tr>
        </thead>
        <tbody id="expenseTableBody" class="bg-white"></tbody>
    </table>

    <!-- Pagination -->
    <div class="flex justify-between mt-4">
        <button onclick="prevPage()" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">Previous</button>
        <span id="pageInfo" class="text-gray-700 font-semibold"></span>
        <button onclick="nextPage()" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">Next</button>
    </div>
</div>

<script>
let accessToken = localStorage.getItem('access_token') || null;
let currentPage = 1;
let totalPages = 1;

// Login function
async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const msg = document.getElementById('loginMessage');

    if (!email || !password) { msg.innerText = 'Email and password are required'; return; }

    try {
        const res = await fetch('/api/login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok) {
            accessToken = data.access;
            localStorage.setItem('access_token', accessToken);
            msg.innerText = 'Login Successful';
            msg.className = 'text-green-500 mt-2';
            currentPage = 1;
            fetchExpenses();
        } else {
            msg.innerText = data.error || 'Login failed';
            msg.className = 'text-red-500 mt-2';
        }
    } catch (err) {
        msg.innerText = 'Server error';
    }
}

// Add Expense
async function addExpense() {
    if (!accessToken) { document.getElementById('expenseMessage').innerText = 'Please login first'; return; }

    const amount = document.getElementById('amount').value;
    const category = document.getElementById('category').value;
    const description = document.getElementById('description').value;
    const date = document.getElementById('date').value;
    const msg = document.getElementById('expenseMessage');

    if (!amount || !category || !description || !date) { msg.innerText = 'All fields are required'; return; }

    try {
        const res = await fetch(`/api/expenses/?page=${currentPage}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({ amount: parseFloat(amount), category, description, date })
        });
        const data = await res.json();
        if (res.ok) {
            msg.innerText = 'Expense added';
            msg.className = 'text-green-500 mt-2';
            document.getElementById('amount').value = '';
            document.getElementById('category').value = '';
            document.getElementById('description').value = '';
            document.getElementById('date').value = '';
            fetchExpenses();
        } else if (data) {
            const errors = Object.values(data).flat().join(', ');
            msg.innerText = errors || 'Failed to add expense';
            msg.className = 'text-red-500 mt-2';
        }
    } catch (err) {
        msg.innerText = 'Server error';
        msg.className = 'text-red-500 mt-2';
    }
}

// Fetch Expenses
async function fetchExpenses() {
    if (!accessToken) return;

    const sort = document.getElementById('sort').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    let url = `/api/expenses/?page=${currentPage}&sort=${sort}`;
    if (startDate && endDate) url += `&startDate=${startDate}&endDate=${endDate}`;

    try {
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + accessToken } });
        const data = await res.json();
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = '';
        if (data.results) {
            totalPages = Math.ceil(data.count / 5);
            data.results.forEach(exp => {
                const row = `<tr class="border-b border-gray-200">
                    <td class="p-2">${exp.date}</td>
                    <td class="p-2">${exp.category}</td>
                    <td class="p-2">${exp.description}</td>
                    <td class="p-2">${exp.amount}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
            document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages}`;
        }
    } catch (err) {
        console.error('Failed to fetch expenses');
    }
}

function nextPage() { if (currentPage < totalPages) { currentPage++; fetchExpenses(); } }
function prevPage() { if (currentPage > 1) { currentPage--; fetchExpenses(); } }

// Auto-fetch on load
if (accessToken) fetchExpenses();
</script>

</body>
</html>
